[
    {
        "name": "Surgi Customer Statement",
        "standard": true,
        "print_format_for": "DocType",
        "doc_type": "Customer Statement",
        "print_format_type": "Jinja",
        "margin_top": 15,
        "margin_bottom": 15,
        "margin_left": 15,
        "margin_right": 15,
        "html": "{, --- Initialize and calculate balance first --- #} {% set ns = namespace(balance=0) %} {% set today = frappe.utils.getdate() %} {, Calculate Balance Forward #} {% set bf\_data = frappe.db.sql(\"\"\" SELECT SUM(debit - credit) as balance\_forward FROM `tabGL Entry` WHERE party\_type = 'Customer' AND party = %(customer)s AND posting\_date < %(from\_date)s AND is\_cancelled = 0 \"\"\", { \"customer\": doc.customer, \"from\_date\": doc.from\_date }, as\_dict=True) %} {% set balance\_forward = 0 %} {% if bf\_data and bf\_data[0].balance\_forward is not none %} {% set balance\_forward = bf\_data[0].balance\_forward %} {% endif %} {% set ns.balance = balance\_forward %} {, Calculate all ledger entries to get final balance #} {% set ledger\_entries = frappe.get\_all(\"GL Entry\", filters={ \"party\_type\": \"Customer\", \"party\": doc.customer, \"posting\_date\": [\"between\", [doc.from\_date, doc.to\_date]], \"is\_cancelled\": 0 }, fields=[\"posting\_date\", \"voucher\_type\", \"voucher\_no\", \"debit\", \"credit\", \"against\_voucher\"], order\_by=\"posting\_date asc, creation asc\") %} {% for entry in ledger\_entries %} {% if entry.credit %} {% set amount = -entry.credit %} {% else %} {% set amount = entry.debit %} {% endif %} {% set ns.balance = ns.balance + amount %} {% endfor %} {, Get customer details #} {% set customer\_doc = frappe.get\_doc(\"Customer\", doc.customer) %}  |  |  |  |  |  |  | | --- | --- | --- | --- | --- | --- | | **SurgiShop**  19235 N US Highway 41  Lutz, FL 33549  +18557202285  accounting@surgishop.com  www.SurgiShop.com Statement **TO**  {{ customer\_doc.customer\_name }}  {% if customer\_doc.customer\_primary\_contact %} {% set contact = frappe.get\_doc(\"Contact\", customer\_doc.customer\_primary\_contact) %} {{ contact.first\_name }} {{ contact.last\_name }}  {% endif %} {% if customer\_doc.customer\_primary\_address %} {% set address = frappe.get\_doc(\"Address\", customer\_doc.customer\_primary\_address) %} {{ address.address\_line1 }}  {% if address.address\_line2 %}{{ address.address\_line2 }} {% endif %} {{ address.city }}, {{ address.state }} {{ address.pincode }} {{ address.country }} {% endif %} | Logo  |  |  | | --- | --- | | **DATE** | {{ doc.posting\_date or today }} | | **TOTAL DUE ENCLOSED** | $ {{ \"{:,.2f}\".format(ns.balance) }} | |  | DATE | DESCRIPTION | AMOUNT | BALANCE | | --- | --- | --- | --- | {, Reset balance to start fresh for the table display #} {% set ns.balance = balance\_forward %}| {{ doc.from\_date }} (Balance Forward) | Balance Forward |  | {{ \"{:,.2f}\".format(ns.balance) }} | {, Ledger Entries - reuse the already fetched entries #} {% for entry in ledger\_entries %} {% if entry.credit %} {% set amount = -entry.credit %} {% else %} {% set amount = entry.debit %} {% endif %} {, --- Update the balance inside the namespace --- #} {% set ns.balance = ns.balance + amount %}| {{ entry.posting\_date }} | {{ entry.voucher\_type }} {{ entry.voucher\_no }} | {{ \"{:,.2f}\".format(amount) }} | {{ \"{:,.2f}\".format(ns.balance) }} | {% endfor %}  {, Past-Due / Aging - break down ns.balance by invoice age #} {% set days\_1\_30 = 0 %} {% set days\_31\_60 = 0 %} {% set days\_61\_90 = 0 %} {% set days\_over\_90 = 0 %} {% for inv in frappe.get\_all(\"Sales Invoice\", filters={ \"customer\": doc.customer, \"docstatus\": 1, \"outstanding\_amount\": [\">\", 0] }, fields=[\"posting\_date\", \"outstanding\_amount\"]) %} {% set amt = inv.outstanding\_amount %} {% set days\_due = (today - inv.posting\_date).days %} {% if days\_due >= 1 and days\_due <= 30 %} {% set days\_1\_30 = days\_1\_30 + amt %} {% elif days\_due >= 31 and days\_due <= 60 %} {% set days\_31\_60 = days\_31\_60 + amt %} {% elif days\_due >= 61 and days\_due <= 90 %} {% set days\_61\_90 = days\_61\_90 + amt %} {% elif days\_due > 90 %} {% set days\_over\_90 = days\_over\_90 + amt %} {% endif %} {% endfor %}  | Current Due | 1-30 Days Past Due | 31-60 Days Past Due | 61-90 Days Past Due | 90+ Days Past Due | Amount Due | | --- | --- | --- | --- | --- | --- | | {{ \"{:,.2f}\".format(ns.balance) }} | {{ \"{:,.2f}\".format(days\_1\_30) }} | {{ \"{:,.2f}\".format(days\_31\_60) }} | {{ \"{:,.2f}\".format(days\_61\_90) }} | {{ \"{:,.2f}\".format(days\_over\_90) }} | {{ \"{:,.2f}\".format(ns.balance) }} |  **Pay your Invoice Online: Pay.SurgiShop.com**  For more information please email Accounting@SurgiShop.com",
        "doctype": "Print Format"
    }
]
